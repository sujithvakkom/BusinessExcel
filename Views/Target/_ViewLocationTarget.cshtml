@using BusinessExcel.Models
@using BusinessExcel.Providers.ProviderContext.Entities
@using BusinessExcel.Providers.ProviderContext
@using BusinessExcel.Controllers.JSON
@using BusinessExcel.Controllers
@using BootstrapHtmlHelper

@{
    using (var db = new SalesManageDataContext())
    {


        var lineTargets =
        db.Database.SqlQuery<LocationTarget>(
             @"SELECT t.target_id, r.name, r.start_date, r.end_date, r.location_id, l.description
                   FROM[db_salesmanage_user].[target_m] AS t INNER JOIN[db_salesmanage_user].[roster] AS r ON t.roster_id = r.roster_id
                                                              INNER JOIN[sc_salesmanage_user].[location_m] AS l ON r.location_id = l.location_id
                   WHERE l.deleted = @deleted
                         AND
                         t.user_id IS NULL",
             new System.Data.SqlClient.SqlParameter("@deleted", System.Data.SqlDbType.BigInt) { Value = 0 });
        <table class="table table-bordered">
            @foreach (var lineTarget in lineTargets)
            {

                <thead class="thead-light">
                    <tr><th scope="row" width="100px">Period</th><td colspan="3">@lineTarget.description</td></tr>
                </thead>
                <thead class="thead-light">
                    <tr><th scope="row" width="100px">Start Date</th><td colspan="3">@lineTarget.start_date</td></tr>
                </thead>
                <thead class="thead-light">
                    <tr><th scope="row" width="100px">End Date</th><td colspan="3">@lineTarget.end_date</td></tr>
                </thead>
                <thead class="thead-light">
                    <tr><th scope="row" width="100px">Site</th><td colspan="3">@lineTarget.description</td></tr>
                </thead>
                var lines =
                db.Database.SqlQuery
                <LocationTargetLine>
                    (
                    @"
SELECT row_num ,
       category_id ,
       has_bonus ,
       category ,
       SUM(value) AS value
FROM ( SELECT ROW_NUMBER() OVER(PARTITION BY ut.category_id ,
                                             ut.has_bonus ORDER BY ut.category_id DESC) AS row_num ,
              ut.category_id ,
              ut.has_bonus ,
              c.description AS                                                             category ,
              ut.value AS                                                                  value
       FROM [db_salesmanage_user].[target_m] AS t INNER JOIN [db_salesmanage_user].[roster] AS r ON t.roster_id = r.roster_id
                                                  INNER JOIN [sc_salesmanage_user].[location_m] AS l ON r.location_id = l.location_id
                                                  INNER JOIN [db_salesmanage_user].[user_target] AS ut ON t.target_id = ut.target_id
                                                  LEFT JOIN [sc_salesmanage_merchant].category AS c ON ut.category_id = c.category_id
       WHERE l.deleted = @deleted
             AND
             t.target_id = @target_id
             AND
             t.user_id IS NULL
     ) AS a
GROUP BY row_num ,
         category_id ,
         has_bonus ,
         category",
                    new System.Data.SqlClient.SqlParameter("@deleted", System.Data.SqlDbType.BigInt) { Value = 0 },
                    new System.Data.SqlClient.SqlParameter("@target_id", System.Data.SqlDbType.BigInt) { Value = lineTarget.target_id });
                <tr><th scope="col">No.</th><th scope="col">Bonus</th><th>Line</th><th>Target</th></tr>
                foreach (var l in lines)
                {
                    <tr><td>@l.row_num</td><td>@(l.has_bonus?"Yes":"No")</td><td>@l.category</td><td class="text-right">@l.value</td></tr>
                }

                <tr><td class="no-border" colspan="4"></td></tr>
            }
        </table>
    }
}